[![Wazuh](https://img.shields.io/badge/Wazuh-v4.14.x-blue)](https://wazuh.com/)
[![YARA](https://img.shields.io/badge/YARA-v4.5.5-red)](https://virustotal.github.io/yara/)

# WAZUH - COMPLETE CONFIGURATION GUIDE
## Quick Reference Guide | DETECT - Cybersecurity Training

---

## üìã TABLE OF CONTENTS

1. [Environment Architecture](#environment-architecture)
2. [Wazuh Installation](#wazuh-installation)
3. [Basic Configuration](#basic-configuration)
4. [File Integrity Monitoring (FIM)](#file-integrity-monitoring-fim)
5. [YARA Integration - Malware Detection](#yara-integration---malware-detection)
6. [Malicious IP Blocking (CDB Lists)](#malicious-ip-blocking-cdb-lists)
7. [Brute Force Detection](#brute-force-detection)
8. [SQL Injection Detection](#sql-injection-detection)
9. [Active Response](#active-response)
10. [Troubleshooting](#troubleshooting)
11. [Useful Commands](#useful-commands)

---

## üèóÔ∏è ENVIRONMENT ARCHITECTURE

### Components

| Component | Operating System | IP | Services | Wazuh |
|-----------|------------------|-----|----------|-------|
| **Wazuh Server** | Ubuntu 22.04 | 192.168.1.121 | Manager, Indexer, Dashboard | v4.14.1 |
| **Linux Agent** | Debian 13 Trixie | 192.168.1.122 | Apache, SSH | Agent v4.14.x |
| **Windows Agent** | Windows 10/11 | Variable | RDP, SMB | Agent v4.14.x |
| **Kali Attacker** | Kali Linux | Variable | Hydra, curl | N/A |

### Ports Used

- **1514/TCP** - Agent ‚Üí Manager (communication)
- **1515/TCP** - Agent ‚Üí Manager (enrollment)
- **55000/TCP** - Manager API
- **443/TCP** - Web Dashboard
- **9200/TCP** - Indexer

---

## üîß WAZUH INSTALLATION

### Server (Ubuntu 22.04)

```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Wazuh (Quick Start)
curl -sO https://packages.wazuh.com/4.14/wazuh-install.sh
sudo bash ./wazuh-install.sh -a

# Save admin password
cat ~/wazuh-install-files/wazuh-passwords.txt

# Access Dashboard
# https://SERVER_IP
# user: admin | password: (from file above)
```

### Linux Agent

```bash
# Commands automatically generated by Dashboard:
# Agents ‚Üí Deploy new agent ‚Üí Linux

curl -so wazuh-agent.deb https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/wazuh-agent_4.14.x_amd64.deb

sudo WAZUH_MANAGER='192.168.1.121' dpkg -i ./wazuh-agent.deb

sudo systemctl daemon-reload
sudo systemctl enable wazuh-agent
sudo systemctl start wazuh-agent
```

### Windows Agent

1. Dashboard ‚Üí Agents ‚Üí Deploy new agent ‚Üí Windows
2. Configure Server address: `192.168.1.121`
3. Download MSI installer
4. Run as Administrator
5. Verify: `Get-Service -Name "WazuhSvc"`

---

## ‚öôÔ∏è BASIC CONFIGURATION

### Configuration Files

| Location | Component | Description |
|----------|-----------|-------------|
| `/var/ossec/etc/ossec.conf` | Server | Main Manager configuration |
| `/var/ossec/etc/ossec.conf` | Linux Agent | Agent configuration |
| `C:\Program Files (x86)\ossec-agent\ossec.conf` | Windows Agent | Agent configuration |
| `/var/ossec/etc/rules/local_rules.xml` | Server | Custom rules |
| `/var/ossec/etc/decoders/local_decoder.xml` | Server | Custom decoders |
| `/var/ossec/etc/lists/` | Server | CDB lists |

### Management Commands

```bash
# SERVER
sudo systemctl status wazuh-manager
sudo systemctl restart wazuh-manager
sudo systemctl stop wazuh-manager

# LINUX AGENT
sudo systemctl status wazuh-agent
sudo systemctl restart wazuh-agent

# WINDOWS AGENT (PowerShell as Admin)
Get-Service -Name "WazuhSvc"
net stop WazuhSvc
net start WazuhSvc
```

---

## üìÅ FILE INTEGRITY MONITORING (FIM)

### Concept

FIM monitors changes in critical files and directories, detecting:
- **File creation** (Rule 554)
- **File modification** (Rule 550)
- **File deletion** (Rule 553)
- **Permission changes** (Rule 550)
- **Owner changes** (Rule 550)

### Linux Agent Configuration

**File:** `/var/ossec/etc/ossec.conf`

```xml
<syscheck>
  <disabled>no</disabled>
  <frequency>43200</frequency>  <!-- Scan every 12h -->
  <scan_on_start>yes</scan_on_start>
  
  <!-- Real-time monitoring -->
  <directories check_all="yes" realtime="yes">/tmp/yara/malware</directories>
  <directories check_all="yes" realtime="yes">/var/www/html</directories>
  <directories check_all="yes" realtime="yes">/home</directories>
  
  <!-- Scheduled monitoring -->
  <directories>/etc,/usr/bin,/usr/sbin</directories>
  <directories>/bin,/sbin,/boot</directories>
  
  <!-- Files to ignore -->
  <ignore>/etc/mtab</ignore>
  <ignore>/etc/hosts.deny</ignore>
  <ignore type="sregex">.log$|.swp$</ignore>
</syscheck>
```

### Windows Agent Configuration

**File:** `C:\Program Files (x86)\ossec-agent\ossec.conf`

```xml
<syscheck>
  <disabled>no</disabled>
  <frequency>43200</frequency>
  <scan_on_start>yes</scan_on_start>
  
  <!-- Monitor share -->
  <directories check_all="yes" realtime="yes">C:\partilha</directories>
  
  <!-- Monitor user folders -->
  <directories check_all="yes" realtime="yes">C:\Users\%USERNAME%</directories>
</syscheck>
```

### Important Parameters

| Parameter | Values | Description |
|-----------|--------|-------------|
| `disabled` | `yes`/`no` | Enable/disable FIM |
| `frequency` | Seconds | Interval between scans (43200 = 12h) |
| `scan_on_start` | `yes`/`no` | Scan when agent starts |
| `check_all` | `yes`/`no` | Monitor everything (size, permissions, hash, etc.) |
| `realtime` | `yes`/`no` | Real-time detection (vs periodic) |

### Default FIM Rules

- **Rule 550** - File modified
- **Rule 551** - Integrity checksum changed
- **Rule 553** - File deleted
- **Rule 554** - File added to the system

### FIM Testing

```bash
# Linux
sudo touch /tmp/yara/malware/test_fim.txt
sudo echo "test" >> /tmp/yara/malware/test_fim.txt

# Check alerts on server
sudo tail -f /var/ossec/logs/alerts/alerts.log | grep -i syscheck
```

---

## ü¶† YARA INTEGRATION - MALWARE DETECTION

### üìå Overview

**YARA** = Yet Another Ridiculous Acronym (or Yet Another Recursive Acronym)

Pattern recognition engine for malware identification through rules describing malware families or suspicious files.

### Workflow

```
1. File created/modified in /tmp/yara/malware
2. FIM detects (Rule 100301 - File added)
3. Active Response triggers ‚Üí yara.sh executes on agent
4. YARA analyzes file ‚Üí compares with rules
5. If match ‚Üí writes to active-responses.log
6. Decoder processes ‚Üí extracts yara_rule, yara_scanned_file
7. Rule 108001 triggers ‚Üí YARA alert generated
8. Dashboard shows ‚Üí Malware detected
```

---

## üêß YARA CONFIGURATION - LINUX AGENT

### 1. Install YARA on Agent

```bash
# Dependencies
sudo apt update
sudo apt install -y make gcc autoconf libtool libssl-dev pkg-config jq

# Download YARA
sudo curl -LO https://github.com/VirusTotal/yara/archive/v4.5.5.tar.gz

# Extract and compile
sudo tar -xvzf v4.5.5.tar.gz -C /usr/local/bin/
cd /usr/local/bin/yara-4.5.5/
sudo ./bootstrap.sh
sudo ./configure
sudo make
sudo make install
sudo make check

# Verify installation
yara --version
# Should return: 4.5.5
```

### 2. Download YARA Rules

```bash
# Create rules directory
sudo mkdir -p /tmp/yara/rules

# Download Valhalla rules (2711 rules)
sudo curl 'https://valhalla.nextron-systems.com/api/v1/get' \
  -H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8' \
  --compressed \
  --data 'demo=demo&apikey=1111111111111111111111111111111111111111111111111111111111111111&format=text' \
  -o /tmp/yara/rules/yara_rules.yar

# Verify download
ls -lh /tmp/yara/rules/
# Should show: yara_rules.yar (~2.4M)
```

### 3. Active Response Script (yara.sh)

**File:** `/var/ossec/active-response/bin/yara.sh`

**‚ö†Ô∏è CRITICAL FIX:** Absolute path for LOG_FILE

```bash
#!/bin/bash
# YARA Active Response Script

LOCAL=`dirname $0`
cd $LOCAL
cd ../

# ‚úÖ IMPORTANT: ABSOLUTE path
LOG_FILE="/var/ossec/logs/active-responses.log"

# Process JSON received via stdin
read INPUT_JSON
YARA_PATH=$(echo $INPUT_JSON | jq -r .parameters.extra_args[1])
YARA_RULES=$(echo $INPUT_JSON | jq -r .parameters.extra_args[3])
FILENAME=$(echo $INPUT_JSON | jq -r .parameters.alert.syscheck.path)

# Execute YARA
${YARA_PATH}/yara -w -r ${YARA_RULES} ${FILENAME} >> ${LOG_FILE} 2>&1
```

**Permissions:**

```bash
sudo chown root:wazuh /var/ossec/active-response/bin/yara.sh
sudo chmod 750 /var/ossec/active-response/bin/yara.sh
```

### 4. Configure FIM for YARA (Agent)

**File:** `/var/ossec/etc/ossec.conf`

```xml
<syscheck>
  <disabled>no</disabled>
  <frequency>43200</frequency>
  <scan_on_start>yes</scan_on_start>
  
  <!-- ‚úÖ YARA - Real-time monitoring -->
  <directories check_all="yes" realtime="yes">/tmp/yara/malware</directories>
  
  <!-- Other configurations... -->
</syscheck>
```

**Create directory:**

```bash
sudo mkdir -p /tmp/yara/malware
```

**Restart agent:**

```bash
sudo systemctl restart wazuh-agent
```

---

## üñ•Ô∏è YARA CONFIGURATION - WAZUH SERVER

### 1. Custom Rules

**File:** `/var/ossec/etc/rules/local_rules.xml`

**‚ö†Ô∏è CORRECT XML STRUCTURE:**

```xml
<!-- SSH Group (if exists) -->
<group name="local,syslog,sshd,">
  <rule id="100001" level="5">
    <if_sid>5716</if_sid>
    <srcip>!192.168.1.0/24</srcip>
    <description>sshd: authentication failed from IP outside local network.</description>
  </rule>
</group>

<!-- ‚úÖ FIM Group - File detection in /tmp/yara/malware -->
<group name="syscheck,">
  <rule id="100300" level="7">
    <if_sid>550</if_sid>
    <field name="file">/tmp/yara/malware/</field>
    <description>File modified in /tmp/yara/malware directory.</description>
  </rule>
  
  <rule id="100301" level="7">
    <if_sid>554</if_sid>
    <field name="file">/tmp/yara/malware/</field>
    <description>File added to /tmp/yara/malware directory.</description>
  </rule>
</group>

<!-- ‚úÖ YARA Group - Malware detection -->
<group name="yara,">
  <rule id="108000" level="0">
    <decoded_as>yara_decoder</decoded_as>
    <description>YARA grouping rule</description>
  </rule>
  
  <rule id="108001" level="12">
    <if_sid>108000</if_sid>
    <match>wazuh-yara: INFO - Scan result: </match>
    <description>File "$(yara_scanned_file)" is a positive match. YARA rule: $(yara_rule)</description>
  </rule>
</group>
```

**‚ö†Ô∏è Important Notes:**
- Each `<group>` must have closing tag `</group>`
- Don't leave groups "open" without closing
- Verify XML indentation

### 2. Custom Decoders

**File:** `/var/ossec/etc/decoders/local_decoder.xml`

```xml
<!-- Base decoder for YARA logs -->
<decoder name="yara_decoder">
  <prematch>wazuh-yara:</prematch>
</decoder>

<!-- Decoder to extract fields -->
<decoder name="yara_decoder1">
  <parent>yara_decoder</parent>
  <regex>wazuh-yara: (\S+) - Scan result: (\S+) (\S+)</regex>
  <order>log_type, yara_rule, yara_scanned_file</order>
</decoder>
```

**Extracted fields:**
- `log_type` - INFO, WARNING, ERROR
- `yara_rule` - YARA rule name that matched (e.g., MAL_ELF_LNX_Mirai_Oct10_2_RID2F3A)
- `yara_scanned_file` - Full path of analyzed file

### 3. Configure Active Response

**File:** `/var/ossec/etc/ossec.conf`

**‚ö†Ô∏è CRITICAL FIX:** `<location>all</location>` (not `local`)

```xml
<!-- YARA command for Linux -->
<command>
  <name>yara_linux</name>
  <executable>yara.sh</executable>
  <extra_args>-yara_path /usr/local/bin -yara_rules /tmp/yara/rules/yara_rules.yar</extra_args>
  <timeout_allowed>no</timeout_allowed>
</command>

<!-- YARA Active Response -->
<active-response>
  <disabled>no</disabled>
  <command>yara_linux</command>
  <location>all</location>  <!-- ‚úÖ IMPORTANT: 'all' to execute on agent -->
  <rules_id>100300,100301</rules_id>
</active-response>
```

**Parameters `extra_args`:**
- `-yara_path` - Directory where YARA binary is located
- `-yara_rules` - Full path to rules file

**Restart Manager:**

```bash
sudo systemctl restart wazuh-manager
sudo systemctl status wazuh-manager
```

---

## üß™ YARA TESTING - MALWARE SAMPLES

### Malware Download Script

**File:** `/tmp/yara/malware/malware_downloader.sh`

```bash
#!/bin/bash

echo "Downloading malware samples for YARA testing..."

# Mirai botnet
wget https://bazaar.abuse.ch/sample/10f8f2573cbb3954d3c0908af9e53daca56ab6db7c5239f92c7cf917549dea6c/ -O mirai

# xbash malware
wget https://bazaar.abuse.ch/sample/25d1d6caf2b8e4e9a5f3c6a45f3f2f5f8f5f5f5f5f5f5f5f5f5f5f5f5f5f5f5/ -O xbash

# PHP Webshell
wget https://bazaar.abuse.ch/sample/9d3c5e7a8f2b1c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8/ -O webshell.php

# VPNFilter malware
wget https://bazaar.abuse.ch/sample/50ac2b2b3d1c4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9/ -O vpn_filter

echo "Download complete!"
ls -lh
```

### EICAR Test File (Safe)

```bash
# Create EICAR test file (detected by all antivirus)
echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*' > /tmp/yara/malware/eicar.com
```

### Verify Results

**On Agent:**

```bash
# View Active Response logs
sudo tail -f /var/ossec/logs/active-responses.log

# Expected output example:
# wazuh-yara: INFO - Scan result: MAL_ELF_LNX_Mirai_Oct10_2_RID2F3A /tmp/yara/malware/mirai
```

**On Server:**

```bash
# View YARA alerts
sudo tail -f /var/ossec/logs/alerts/alerts.log | grep -A 10 "108001"

# Example output:
# Rule: 108001 (level 12) -> 'File "/tmp/yara/malware/mirai" is a positive match...'
# yara_rule: MAL_ELF_LNX_Mirai_Oct10_2_RID2F3A
# yara_scanned_file: /tmp/yara/malware/mirai
```

**On Dashboard:**

1. Access **Threat Intelligence** ‚Üí **Security Events**
2. Filter by: `rule.id: 108001`
3. Verify alerts with malware details

---

## ü™ü YARA CONFIGURATION - WINDOWS AGENT

### 1. Install YARA

**Download:**
- URL: https://github.com/VirusTotal/yara/releases
- File: `yara-v4.5.5-win64.zip`

**Installation:**

```powershell
# Extract to C:\Program Files\yara\
# Add to system PATH:
# System ‚Üí Properties ‚Üí Environment Variables ‚Üí PATH
# Add: C:\Program Files\yara\

# Verify
yara --version
```

### 2. YARA Rules

```powershell
# Create directory
mkdir C:\yara_rules

# Download Valhalla rules
Invoke-WebRequest -Uri "https://valhalla.nextron-systems.com/api/v1/get" `
  -Method POST `
  -Body "demo=demo&apikey=1111111111111111111111111111111111111111111111111111111111111111&format=text" `
  -OutFile "C:\yara_rules\yara_rules.yar"
```

### 3. yara.bat Script

**File:** `C:\Program Files (x86)\ossec-agent\active-response\bin\yara.bat`

```batch
@echo off
setlocal

set /p INPUT_JSON=

for /f "tokens=2 delims=:" %%a in ('echo %INPUT_JSON% ^| findstr /i "path"') do (
    set FILEPATH=%%a
)

set FILEPATH=%FILEPATH:"=%
set FILEPATH=%FILEPATH:}=%
set FILEPATH=%FILEPATH: =%

"C:\Program Files\yara\yara64.exe" -r ^
  "C:\yara_rules\yara_rules.yar" ^
  "%FILEPATH%" >> "C:\Program Files (x86)\ossec-agent\active-responses.log" 2>&1

exit /b 0
```

### 4. Server Configuration (Windows)

**Rules:**

```xml
<group name="syscheck,">
  <rule id="100310" level="7">
    <if_sid>550</if_sid>
    <field name="file">C:\\partilha\\</field>
    <description>File modified in C:\partilha</description>
  </rule>
  
  <rule id="100311" level="7">
    <if_sid>554</if_sid>
    <field name="file">C:\\partilha\\</field>
    <description>File added to C:\partilha</description>
  </rule>
</group>

<group name="yara,">
  <rule id="108010" level="0">
    <decoded_as>yara_decoder</decoded_as>
    <description>Windows YARA grouping</description>
  </rule>
  
  <rule id="108011" level="12">
    <if_sid>108010</if_sid>
    <match>YARA</match>
    <description>Windows malware: $(yara_rule)</description>
  </rule>
</group>
```

**Active Response:**

```xml
<command>
  <name>yara_windows</name>
  <executable>yara.bat</executable>
  <timeout_allowed>no</timeout_allowed>
</command>

<active-response>
  <disabled>no</disabled>
  <command>yara_windows</command>
  <location>local</location>
  <rules_id>100310,100311</rules_id>
</active-response>
```

---

## üö´ MALICIOUS IP BLOCKING (CDB LISTS)

### Concept

**CDB = Constant Database** - Key:value database optimized for fast lookups

Format:
```
192.168.1.50:malicious
10.0.0.23:botnet
```

### 1. Create IP List (Server)

```bash
# Download AlienVault list
sudo wget https://iplists.firehol.org/files/alienvault_reputation.ipset \
  -O /var/ossec/etc/lists/alienvault_reputation.ipset

# Add attacker IP
sudo echo "ATTACKER_IP" >> /var/ossec/etc/lists/alienvault_reputation.ipset
```

### 2. Convert to CDB

```bash
# Download conversion script
sudo wget https://wazuh.com/resources/iplist-to-cdblist.py -O /tmp/iplist-to-cdblist.py

# Convert
sudo /var/ossec/framework/python/bin/python3 /tmp/iplist-to-cdblist.py \
  /var/ossec/etc/lists/alienvault_reputation.ipset \
  /var/ossec/etc/lists/blacklist-alienvault

# Permissions
sudo chown wazuh:wazuh /var/ossec/etc/lists/blacklist-alienvault

# Clean temporary files
sudo rm -rf /var/ossec/etc/lists/alienvault_reputation.ipset
sudo rm -rf /tmp/iplist-to-cdblist.py
```

### 3. Add List to ossec.conf

```xml
<ossec_config>
  <ruleset>
    <!-- Default ruleset -->
    <decoder_dir>ruleset/decoders</decoder_dir>
    <rule_dir>ruleset/rules</rule_dir>
    <rule_exclude>0215-policy_rules.xml</rule_exclude>
    <list>etc/lists/audit-keys</list>
    <list>etc/lists/amazon/aws-eventnames</list>
    <list>etc/lists/security-eventchannel</list>
    
    <!-- ‚úÖ Malicious IP CDB list -->
    <list>etc/lists/blacklist-alienvault</list>
    
    <!-- User-defined ruleset -->
    <decoder_dir>etc/decoders</decoder_dir>
    <rule_dir>etc/rules</rule_dir>
  </ruleset>
</ossec_config>
```

### 4. Custom Rule

**For Linux (Apache):**

```xml
<group name="attack,">
  <rule id="100100" level="10">
    <if_group>web|attack|attacks</if_group>
    <list field="srcip" lookup="address_match_key">etc/lists/blacklist-alienvault</list>
    <description>IP address found in AlienVault reputation database.</description>
  </rule>
</group>
```

**For Windows (RDP):**

```xml
<group name="attack,">
  <rule id="100110" level="10">
    <if_group>authentication</if_group>
    <list field="srcip" lookup="address_match_key">etc/lists/blacklist-alienvault</list>
    <description>Malicious IP detected - Windows RDP</description>
  </rule>
</group>
```

### 5. Active Response

**Linux (firewall-drop):**

```xml
<active-response>
  <disabled>no</disabled>
  <command>firewall-drop</command>
  <location>local</location>
  <rules_id>100100</rules_id>
  <timeout>600</timeout>
</active-response>
```

**Windows (netsh):**

```xml
<active-response>
  <disabled>no</disabled>
  <command>netsh</command>
  <location>local</location>
  <rules_id>100110</rules_id>
  <timeout>600</timeout>
</active-response>
```

### Testing

```bash
# From attacker (Kali), access target server/service
curl http://TARGET_IP/

# Repeat 5-10 times
for i in {1..10}; do curl http://TARGET_IP/; sleep 1; done

# Verify blocking on target
# Linux:
sudo iptables -L -n | grep ATTACKER_IP

# Windows:
netsh advfirewall firewall show rule name=all | findstr "Wazuh"
```

---

## üî® BRUTE FORCE DETECTION

### Monitored Logs

**SSH (Linux):**
- `/var/log/auth.log` (Debian/Ubuntu)
- `/var/log/secure` (CentOS/RHEL)

### Default Wazuh Rules

- **Rule 5710** - Invalid user
- **Rule 5711** - Failed attempt
- **Rule 5716** - Possible SSH brute force attack
- **Rule 5720** - Multiple authentication failures
- **Rule 5763** - SSH brute force confirmed

### Simulated Attack (Hydra)

```bash
# Install Hydra
sudo apt install -y hydra

# Create password list
cat > passwords.txt << EOF
123456
password
qwerty
admin
letmein
welcome
test123
linux
ubuntu
badpass
EOF

# Execute attack
hydra -l badguy -P passwords.txt TARGET_IP ssh -t 4
```

### Verify Detection

```bash
# Dashboard
# Filter: rule.id:(5551 OR 5712 OR 5716 OR 5720 OR 5763)

# Command line
sudo tail -200 /var/ossec/logs/alerts/alerts.log | grep -E "5551|5712|5716|5720|5763"
```

---

## üíâ SQL INJECTION DETECTION

### Configure Apache Logs (Agent)

```xml
<localfile>
  <log_format>apache</log_format>
  <location>/var/log/apache2/access.log</location>
</localfile>
```

### Default Rule

- **Rule 31106** - SQL injection attempt detected

### Simulated Attacks

```bash
# Attack 1: SELECT
curl -XGET "http://TARGET_IP/users/?id=SELECT+*+FROM+users"

# Attack 2: UNION
curl -XGET "http://TARGET_IP/search?q=test'+UNION+SELECT+null,null--"

# Attack 3: OR 1=1
curl -XGET "http://TARGET_IP/login.php?id=1'+OR+'1'='1"

# Attack 4: Comment injection
curl -XGET "http://TARGET_IP/login.php?user=admin'--"
```

### Verify Detection

```bash
# Dashboard: rule.id:31106

# Logs
sudo tail -200 /var/ossec/logs/alerts/alerts.log | grep -i "31106"
```

---

## ‚ö° ACTIVE RESPONSE

### Concept

Automatic response mechanism to specific alerts.

### Available Commands

| Command | System | Action |
|---------|--------|--------|
| `firewall-drop` | Linux | Block IP via iptables |
| `netsh` | Windows | Block IP via Windows Firewall |
| `disable-account` | Linux/Windows | Disable user account |
| `restart-wazuh` | Agent | Restart Wazuh agent |
| **Custom** | Any | Custom scripts (yara.sh, etc.) |

### Structure

```xml
<!-- 1. Define command -->
<command>
  <name>command_name</name>
  <executable>script.sh</executable>
  <extra_args>-argument1 value1 -argument2 value2</extra_args>
  <timeout_allowed>yes/no</timeout_allowed>
</command>

<!-- 2. Define response -->
<active-response>
  <disabled>no</disabled>
  <command>command_name</command>
  <location>local|server|all</location>
  <rules_id>100,101,102</rules_id>
  <timeout>600</timeout>
</active-response>
```

### Parameters

- `location="local"` - Execute on the agent where alert was generated
- `location="server"` - Execute on Wazuh server
- `location="all"` - Execute on all agents
- `timeout` - Time (seconds) until reverting action (e.g., unblock IP)

### Complete Example: Malicious IP Blocking

```xml
<command>
  <name>firewall-drop</name>
  <executable>firewall-drop</executable>
  <timeout_allowed>yes</timeout_allowed>
</command>

<active-response>
  <disabled>no</disabled>
  <command>firewall-drop</command>
  <location>local</location>
  <rules_id>100100</rules_id>
  <timeout>600</timeout>
</active-response>
```

**Workflow:**
1. Rule 100100 triggers (Malicious IP detected)
2. Active Response calls `firewall-drop`
3. Script adds iptables rule: `iptables -I INPUT -s MALICIOUS_IP -j DROP`
4. After 600 seconds (10 min), rule is automatically removed

---

## üîç TROUBLESHOOTING

### Problem: YARA not detecting malware

**Diagnosis:**

```bash
# 1. Check if YARA is installed
yara --version

# 2. Test YARA manually
/usr/local/bin/yara -w -r /tmp/yara/rules/yara_rules.yar /tmp/yara/malware/eicar.com

# 3. Check script permissions
ls -la /var/ossec/active-response/bin/yara.sh

# 4. Check Active Response logs
sudo tail -50 /var/ossec/logs/active-responses.log

# 5. Check agent logs
sudo tail -100 /var/ossec/logs/ossec.log | grep -i yara
```

**Solutions:**

- **yara.sh script:** Verify absolute path for LOG_FILE
- **Active Response:** Verify `<location>all</location>` (not `local`)
- **XML Rules:** Verify group structure (`<group>` properly closed)

### Problem: Agent not connecting to server

```bash
# Check connectivity
telnet SERVER_IP 1514
telnet SERVER_IP 1515

# Check agent configuration
grep "MANAGER_IP" /var/ossec/etc/ossec.conf

# Check logs
sudo tail -50 /var/ossec/logs/ossec.log
```

### Problem: FIM not generating alerts

```bash
# 1. Check if FIM is active
sudo grep -A 10 "<syscheck>" /var/ossec/etc/ossec.conf

# 2. Force scan
sudo /var/ossec/bin/wazuh-control restart

# 3. Check logs
sudo tail -50 /var/ossec/logs/ossec.log | grep -i syscheck
```

### Problem: Wazuh Manager won't restart

```bash
# View specific error
sudo /var/ossec/bin/wazuh-control start

# Check XML syntax
sudo /var/ossec/bin/verify-agent-conf

# Check logs
sudo tail -100 /var/ossec/logs/ossec.log
```

---

## üõ†Ô∏è USEFUL COMMANDS

### Service Management

```bash
# SERVER
sudo systemctl status wazuh-manager
sudo systemctl restart wazuh-manager
sudo systemctl stop wazuh-manager
sudo /var/ossec/bin/wazuh-control start
sudo /var/ossec/bin/wazuh-control stop

# LINUX AGENT
sudo systemctl status wazuh-agent
sudo systemctl restart wazuh-agent
sudo /var/ossec/bin/wazuh-control restart

# WINDOWS AGENT
Get-Service -Name "WazuhSvc"
net stop WazuhSvc && net start WazuhSvc
```

### Agent Verification

```bash
# List connected agents
sudo /var/ossec/bin/agent_control -l

# View specific agent info
sudo /var/ossec/bin/agent_control -i AGENT_ID

# Force config reload
sudo /var/ossec/bin/agent_control -R -a
```

### Log Analysis

```bash
# View alerts in real-time
sudo tail -f /var/ossec/logs/alerts/alerts.log

# View alerts from specific rule
sudo tail -500 /var/ossec/logs/alerts/alerts.log | grep "Rule: 108001"

# View manager logs
sudo tail -f /var/ossec/logs/ossec.log

# View Active Response logs (on agent)
sudo tail -f /var/ossec/logs/active-responses.log
```

### Testing

```bash
# Test specific rule
sudo /var/ossec/bin/wazuh-logtest

# Verify rule syntax
sudo /var/ossec/bin/verify-agent-conf

# Test decoders
echo 'LOG_LINE' | sudo /var/ossec/bin/wazuh-logtest -v
```

### Cleanup and Maintenance

```bash
# Clean old logs (server)
sudo find /var/ossec/logs/alerts/ -name "*.log.*" -mtime +30 -delete

# View space used
sudo du -sh /var/ossec/

# Backup configuration
sudo tar -czf ~/wazuh-config-backup-$(date +%Y%m%d).tar.gz \
  /var/ossec/etc/ossec.conf \
  /var/ossec/etc/rules/local_rules.xml \
  /var/ossec/etc/decoders/local_decoder.xml \
  /var/ossec/etc/lists/
```

---

## üìö REFERENCES

### Official Documentation

- **Wazuh Documentation:** https://documentation.wazuh.com
- **YARA Documentation:** https://yara.readthedocs.io
- **MITRE ATT&CK:** https://attack.mitre.org

### Useful Resources

- **Valhalla YARA Rules:** https://valhalla.nextron-systems.com
- **AlienVault IP Reputation:** https://iplists.firehol.org
- **Wazuh Ruleset:** https://github.com/wazuh/wazuh-ruleset
- **MalwareBazaar:** https://bazaar.abuse.ch

---

---

**Author:** Jorge Moreira  
**Date:** January 2026  
**Version:** 1.0  
**Course:** DETECT - Cybersecurity Training  

---

**üéØ END OF GUIDE**
